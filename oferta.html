document.addEventListener('DOMContentLoaded', () => {
    const email = localStorage.getItem('prof_email');
    const nome = localStorage.getItem('prof_nome');

    // 1. Verifica se o usu√°rio est√° logado
    if (!email) {
        window.location.href = 'login.html';
        return;
    }

    // 2. Personaliza a sauda√ß√£o
    const elUserName = document.getElementById('user-name');
    if (elUserName) {
        // Pega o primeiro nome, mas garante que exista algo para exibir
        const primeiroNome = nome ? nome.trim().split(' ')[0] : 'Professor(a)';
        elUserName.innerText = primeiroNome;
    }

    // 3. Mensagem de sucesso do Checkout (Melhorada)
    const urlParams = new URLSearchParams(window.location.search);
    const msgSucesso = document.getElementById('msg-sucesso');
    if (urlParams.has('sucesso') && msgSucesso) {
        msgSucesso.classList.remove('hidden');
        // Remove o par√¢metro da URL de forma elegante
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    // 4. Inicia a busca
    buscarMeusMateriais(email);
});


async function buscarMeusMateriais(email) {
    const container = document.getElementById('lista-materiais');
    if (!container) return;

    // Feedback de carregamento com Spinner Seguro
    container.innerHTML = `
        <div class="col-span-full text-center py-20">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f97316; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="color: #64748b; margin-top: 10px; font-weight: 500;">Buscando seus arquivos...</p>
        </div>`;

    try {
        const response = await fetch(`https://educamateriais.shop/meus-materiais?email=${email}`);
        if (!response.ok) throw new Error("Erro na conex√£o");

        const materiais = await response.json();

        if (!materiais || materiais.length === 0) {
            container.innerHTML = `
                <div class="col-span-full bg-white p-12 rounded-[2.5rem] text-center border-2 border-dashed border-slate-200">
                    <div style="font-size: 50px; margin-bottom: 15px;">üìÇ</div>
                    <p style="color: #64748b; font-weight: 600; margin-bottom: 20px;">Sua biblioteca est√° vazia.</p>
                    <button onclick="location.href='index.html'" 
                        style="background: #f97316; color: white; padding: 12px 30px; border-radius: 15px; font-weight: bold; border: none; cursor: pointer;">
                        EXPLORAR LOJA
                    </button>
                </div>`;
            return;
        }

        container.innerHTML = materiais.map(m => {
            const dataFormatada = m.data_venda ? new Date(m.data_venda).toLocaleDateString('pt-BR') : 'Dispon√≠vel';
            const linkValido = m.link_download && m.link_download.length > 5;

            return `
            <div class="group" style="background: white; padding: 20px; border-radius: 28px; border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: all 0.3s;">
                
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="background: #fff7ed; color: #ea580c; width: 56px; height: 56px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        üìÑ
                    </div>
                    
                    <div style="max-width: 250px;">
                        <h3 style="font-weight: 900; color: #1e293b; font-size: 14px; margin: 0; line-height: 1.2;">${m.nome}</h3>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                            <span style="background: #f1f5f9; color: #64748b; font-size: 9px; padding: 2px 8px; border-radius: 20px; font-weight: bold; text-transform: uppercase;">PDF</span>
                            <p style="font-size: 10px; color: #94a3b8; font-weight: 600; margin: 0;">${dataFormatada}</p>
                        </div>
                    </div>
                </div>

                ${linkValido ? `
                    <a href="${m.link_download}" target="_blank" rel="noopener"
                       style="background: #22c55e; color: white; width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: transform 0.2s;"
                       onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </a>
                ` : `
                    <div style="background: #f1f5f9; color: #cbd5e1; width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; cursor: not-allowed;">
                        ‚è≥
                    </div>
                `}
            </div>
            `;
        }).join('');

    } catch (err) {
        container.innerHTML = `<p style="color: #ef4444; font-weight: bold; text-align: center; padding: 20px;">Ops! Ocorreu um erro ao carregar.</p>`;
    }
}

<div id="area-pagamento" class="hidden bg-white rounded-[2.5rem] shadow-xl p-4"></div>